<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Publication Timeline</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main class="container">
    <h1>Black Teacher Archive – Publication Timeline</h1>
    <div class="meta" id="meta"></div>
    <div class="toolbar">
<label for="stateFilter">State:</label>
<select id="stateFilter" class="select">
<option value="__all__">All states</option>
</select>
</div>

    <!-- Histogram -->
    <section class="card pad" id="histogram"></section>

    <!-- Rows: each is a relatedItem_1_titleInfo_title -->
    <section class="card" id="list">
      <div class="header">
        <div class="header-inner">
          <div class="header-title" id="headerTitle">Publication Title</div>
           <div id="list-ruler" style="display:none"></div>
        </div>
      </div>
      <div class="scroll" id="rows"></div>
    </section>
  </main>

  <!-- Detail panel -->
  <aside id="detail" class="panel">
    <div class="panel-head">
      <div class="title">Details</div>
      <button id="detailClose" class="btn">Close</button>
    </div>
    <div id="detailBody" class="panel-body"></div>
  </aside>

  <input id="csvFile" type="file" accept=".csv" style="display:none" />

<script>
  // Prefer uploaded path; fallback to same-folder filename, then manual picker
  const CSV_URL = "/mnt/data/publication_ids.csv";

  function tryFetchCSV(){
    return fetch(CSV_URL).then(r=>{ if(!r.ok) throw new Error(); return r.text(); });
  }

  function toYear(v){ if(v==null) return null; const s=String(v); const m=s.match(/(17|18|19|20)\d{2}/); return m?Number(m[0]):null; }

  // --- CSV Parser -------------------------------------------------------------
  function parseCSV(text){
    const rows=[]; let i=0; const n=text.length; let cur=[]; let field=""; let inQ=false;
    function push(){cur.push(field); field="";}
    function endRow(){rows.push(cur); cur=[];}
    while(i<n){
      const ch=text[i++];
      if(inQ){
        if(ch==='"'){ if(text[i]==='"'){ field+='"'; i++; } else { inQ=false; } }
        else { field+=ch; }
      }else{
        if(ch==='"'){ inQ=true; }
        else if(ch===','){ push(); }
        else if(ch==='\n'){ push(); endRow(); }
        else if(ch==='\r'){ }
        else { field+=ch; }
      }
    }
    push(); if(cur.length) endRow();
    if(rows.length===0) return [];
    const header = rows.shift();
    return rows.map(r=>Object.fromEntries(header.map((h,idx)=>[h, r[idx]??""])));
  }

  // --- Helpers ---------------------------------------------------------------
  function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
  function scaleX(year,min,max,width){ if(!Number.isFinite(year) || min===max) return 0; const t=(Math.min(Math.max(year,min),max)-min)/(max-min); return t*width; }
  function decadeTicks(min,max){ const s=Math.floor(min/10)*10; const e=Math.ceil(max/10)*10; const t=[]; for(let y=s;y<=e;y+=10) t.push(y); return t; }
  function kv(label,value){ return `<div class="kv"><div class="k">${label}</div><div class="v">${value||'—'}</div></div>`; }
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  // ADD near other helpers
function displayStateName(value){
  if (value === "__all__") return null;
  const match = uniqueStates().find(s => s.toLowerCase() === value);
  return match || value.toUpperCase();
}
function updateHeaderTitle(){
  const el = document.getElementById('headerTitle');
  if (!el) return;
  const base = "Publication Title";
  const name = displayStateName(stateFilter);
  el.textContent = name ? `${name} ${base}` : base;
}


  // --- Globals ---------------------------------------------------------------
  let allRows=[], years=[], minYear=1800, maxYear=2000, yearCounts=new Map();
  let stateFilter="__all__";
  let TL_WIDTH = 0;

  function uniqueStates(){
    return Array.from(new Set(allRows.map(r => (r.state||"").trim()).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));
  }
  function filteredAllRows(){
    if(stateFilter==="__all__") return allRows;
    const target = stateFilter.toLowerCase();
    return allRows.filter(r => (r.state||"").toLowerCase()===target);
  }
  function measureTimelineWidth(){
    const scroller=document.querySelector('#list .scroll');
    if(!scroller) return;
    TL_WIDTH = Math.max(0, scroller.clientWidth - 32); // padding adjustment
  }
  window.addEventListener('resize', ()=>{ measureTimelineWidth(); renderRows(); });

  // --- Ruler & Histogram -----------------------------------------------------
  function renderRuler(container, ticks, min, max, width){
    container.innerHTML='';
    const base=el('<div class="ruler"></div>');
    base.appendChild(el('<div class="mid"></div>'));
    ticks.forEach(t=>{
      const x=scaleX(t,min,max,width);
      const tick=el(`<div class="tick" style="left:${x}px"><div class="stem"></div><div class="lbl">${t}</div></div>`);
      base.appendChild(tick);
    });
    container.appendChild(base);
  }

  function renderHistogram(){
    const W=1100, H=140;
    const wrap=document.getElementById('histogram');
    wrap.innerHTML='';
    const scroller=el(`<div class="hist-wrap"><div class="hist" style="width:${W}px;height:${H}px"></div></div>`);
    const inner=scroller.querySelector('.hist');
    const ticks=decadeTicks(minYear,maxYear);
    const maxCount=Math.max(1, ...Array.from(yearCounts.values()));
    Array.from(yearCounts.entries()).forEach(([y,c])=>{
      const x=scaleX(Number(y),minYear,maxYear,W);
      const h=(c/maxCount)*(H-30);
      inner.appendChild(el(`<div class="hist-bar" style="left:${x}px;height:${Math.max(2,h)}px"></div>`));
    });
    inner.appendChild(el('<div class="hist-base"></div>'));
    ticks.forEach(t=>{
      const x=scaleX(t,minYear,maxYear,W);
      inner.appendChild(el(`<div class="tick" style="left:${x}px"><div class="stem"></div><div class="lbl">${t}</div></div>`));
    });
    wrap.appendChild(scroller);
  }

  // --- Row Rendering ---------------------------------------------------------
  function renderRows(){
    const container=document.getElementById('rows');
    container.innerHTML='';
    const rows=filteredAllRows();

    const byCollection=new Map();
    for(const r of rows){
      const key=(r.collection||'Unknown collection').trim()||'Unknown collection';
      if(!byCollection.has(key)) byCollection.set(key,[]);
      byCollection.get(key).push(r);
    }

    const rowsMeta=[...byCollection.entries()].map(([name,items])=>({
      name,
      items,
      earliest: Math.min(...items.map(it=>it.year).filter(Number.isFinite)) || Infinity
    }));
    rowsMeta.sort((a,b)=> (a.earliest - b.earliest) || a.name.localeCompare(b.name));

    measureTimelineWidth();
    const W=TL_WIDTH;
    const ticks=decadeTicks(minYear,maxYear);

    for(const {name,items} of rowsMeta){
      const row=el('<div class="row"></div>');
      const states=[...new Set(items.map(x=>x.state).filter(Boolean))];
      const sub=[states.length?states.join(', '):'',`${items.length} item${items.length!==1?'s':''}`]
        .filter(Boolean).join(' · ');
      const meta=el(`<div class="row-meta">
        <span class="row-title" title="${escapeHtml(name)}">${escapeHtml(name)}</span>
        <span class="row-sub" title="${escapeHtml(sub)}">${escapeHtml(sub)}</span>
      </div>`);

      const tl=el(`<div class="row-timeline"><div class="ruler" style="width:${W}px"></div></div>`);
      const ruler=tl.firstChild;
      ruler.appendChild(el('<div class="mid"></div>'));
      ticks.forEach(t=>{
        const tx=scaleX(t,minYear,maxYear,W);
        ruler.appendChild(el(`<div class="tick" style="left:${tx}px"><div class="stem"></div><div class="lbl">${t}</div></div>`));
      });

      const bucketCounts=new Map();
      for(const it of items){
        if(!Number.isFinite(it.year)) continue;
        const baseX=scaleX(it.year,minYear,maxYear,W);
        const k=Math.round(baseX);
        const c=(bucketCounts.get(k)||0);
        bucketCounts.set(k,c+1);
        const offset=(c%3-1)*4;
        const x=Math.max(0,Math.min(W-2,baseX+offset));
        const m=el(`<div class="marker" style="left:${x}px" title="${it.year}: ${escapeHtml(it.title||it.ident)}"></div>`);
        m.addEventListener('click',ev=>{ev.stopPropagation();openDetail(it);});
        ruler.appendChild(m);
      }

      row.appendChild(meta);
      row.appendChild(tl);
      container.appendChild(row);
    }
  }

  // --- Detail Panel ----------------------------------------------------------
  function openDetail(r){
    const p=document.getElementById('detail');
    document.getElementById('detailBody').innerHTML =
      kv('Title', escapeHtml(r.title))+
      kv('Collection', escapeHtml(r.collection))+
      kv('Identifier', escapeHtml(r.ident))+
      kv('State', escapeHtml(r.state))+
      kv('Year', r.year??'—')+
      kv('Volume', escapeHtml(r.volume))+
      kv('Number', escapeHtml(r.number))+
      kv('Raw year', escapeHtml(r.rawYear));
    p.classList.add('open');
  }
  document.getElementById('detailClose').addEventListener('click',
    ()=>document.getElementById('detail').classList.remove('open'));

  // --- Main Load & Init ------------------------------------------------------
  function loadAndRender(text){
    const parsed=parseCSV(text);
    allRows=parsed.map((d,i)=>({
      id:d['publication_ID']||String(i),
      title:d['titleInfo_title']||'',
      collection:d['relatedItem_1_titleInfo_title']||'',
      ident:d['identifier_#text']||'',
      state:d['state']||'',
      year:toYear(d['year'])??null,
      volume:d['volume']||'',
      number:d['number']||'',
      rawYear:d['year']||'',
    })).filter(r=>r.collection);

    years=allRows.map(r=>r.year).filter(y=>Number.isFinite(y));
    minYear=years.length?Math.min(...years):1800;
    maxYear=years.length?Math.max(...years):2000;
    yearCounts=new Map(); years.forEach(y=>yearCounts.set(y,(yearCounts.get(y)||0)+1));

    // Populate state filter
    const sel=document.getElementById('stateFilter');
    const opts=['__all__',...uniqueStates()];
    sel.innerHTML=opts.map(s=>s==='__all__'
      ?`<option value="__all__">All states</option>`
      :`<option value="${s.toLowerCase()}">${s}</option>`).join('');
    sel.value=stateFilter;
    sel.onchange=(e)=>{
      stateFilter=e.target.value;
      const fr=filteredAllRows();
      document.getElementById('meta').textContent=`${fr.length} of ${allRows.length} items • ${minYear}–${maxYear}`;
      renderRows();
    };

    sel.onchange = (e) => {
  stateFilter = e.target.value;
  const fr = filteredAllRows();
  document.getElementById('meta').textContent =
    `${fr.length} of ${allRows.length} items • ${minYear}–${maxYear}`;
  updateHeaderTitle();     // <-- ADD THIS
  renderRows();
};

    document.getElementById('meta').textContent=
      `${filteredAllRows().length} of ${allRows.length} items • ${minYear}–${maxYear}`;

    renderHistogram();
    renderRows();
    
  }

  tryFetchCSV()
    .then(loadAndRender)
    .catch(()=>{
      fetch('publication_ids.csv').then(r=>{if(!r.ok)throw new Error();return r.text();})
        .then(loadAndRender)
        .catch(()=>{
          document.getElementById('meta').textContent='Could not fetch CSV automatically. Choose a CSV file.';
          const input=document.getElementById('csvFile');
          input.style.display='block';
          input.addEventListener('change',ev=>{
            const f=ev.target.files&&ev.target.files[0]; if(!f) return;
            const reader=new FileReader();
            reader.onload=()=>loadAndRender(reader.result);
            reader.readAsText(f);
          },{once:true});
        });
    });
</script>


</body>
</html>
